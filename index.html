<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Manga Tracker Live</title>
    <style>
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --text: #ffffff;
            --sub: #a0a0a0;
            --accent: #ff6740;
            --green: #00c853;
            --blue: #2962ff;
            --danger: #ff5252;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 15px;
        }

        .container { max-width: 800px; margin: 0 auto; }

        header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px;
        }
        h1 { font-size: 1.4rem; margin: 0; }
        
        button { cursor: pointer; border: none; border-radius: 6px; font-weight: 600; }
        .btn-refresh { 
            background: var(--blue); color: white; padding: 8px 16px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .search-area { display: flex; gap: 10px; margin-bottom: 20px; }
        input {
            flex: 1; padding: 12px; border-radius: 6px; border: 1px solid #333;
            background: #252525; color: white; font-size: 1rem;
        }
        .btn-search { background: var(--accent); color: white; padding: 0 20px; }

        .tabs { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #333; }
        .tab { padding: 10px; cursor: pointer; color: var(--sub); border-bottom: 2px solid transparent; }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        .list { display: flex; flex-direction: column; gap: 15px; }

        .card {
            background: var(--card); padding: 12px; border-radius: 10px;
            display: flex; gap: 15px; position: relative;
        }

        .cover {
            width: 80px; height: 120px; object-fit: cover; border-radius: 6px;
            background: #333; flex-shrink: 0;
        }

        .info { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .title { font-size: 1.1rem; font-weight: bold; line-height: 1.2; margin-bottom: 5px; }
        
        .status-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }

        .badge {
            padding: 4px 10px; border-radius: 4px; font-size: 0.85rem; font-weight: bold;
            display: flex; align-items: center; gap: 6px;
        }
        .badge.latest { background: rgba(0, 200, 83, 0.15); color: var(--green); border: 1px solid rgba(0, 200, 83, 0.3); }
        .badge.licensed { background: rgba(255, 171, 0, 0.15); color: #ffab00; border: 1px solid rgba(255, 171, 0, 0.3); }

        .lang-tag { 
            font-size: 0.7rem; text-transform: uppercase; opacity: 0.8; 
            background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 3px;
        }

        .meta { font-size: 0.75rem; color: #888; margin-top: 2px; }
        .actions { display: flex; gap: 10px; margin-top: 5px; }
        .btn-act { padding: 6px 12px; font-size: 0.8rem; background: #333; color: #ccc; }
        .btn-remove { color: #ff5252; background: none; padding: 6px; }

        .error-box {
            color: var(--danger); background: rgba(255, 82, 82, 0.1);
            padding: 15px; border-radius: 8px; text-align: center; font-size: 0.9rem;
        }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Manga Updates</h1>
        <button class="btn-refresh" onclick="refreshAll()" id="refresh-btn">Check Now</button>
    </header>

    <div class="search-area">
        <input type="text" id="search-input" placeholder="Find manga..." onkeypress="if(event.key==='Enter') search()">
        <button class="btn-search" onclick="search()">Search</button>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('lib')">My List</div>
        <div class="tab" onclick="switchTab('search')">Search Results</div>
    </div>

    <div id="lib-view" class="list"></div>
    <div id="search-view" class="list" style="display:none"></div>
</div>

<script>
    const API = 'https://api.mangadex.org';
    const COVERS = 'https://uploads.mangadex.org/covers';
    // PROXY: This helps us bypass the GitHub/CORS block
    const PROXY_BASE = 'https://api.allorigins.win/raw?url=';
    
    let library = JSON.parse(localStorage.getItem('manga_auto_v1')) || [];

    document.addEventListener('DOMContentLoaded', () => {
        renderLib();
        refreshAll();
    });

    // --- Helper to fetch data safely ---
    async function fetchSafe(targetUrl) {
        // We wrap the MangaDex URL inside the Proxy URL
        const finalUrl = PROXY_BASE + encodeURIComponent(targetUrl);
        const res = await fetch(finalUrl);
        if (!res.ok) throw new Error(`Proxy Error: ${res.status}`);
        return await res.json();
    }

    // --- Search ---
    async function search() {
        const q = document.getElementById('search-input').value.trim();
        if(!q) return;
        
        switchTab('search');
        const view = document.getElementById('search-view');
        view.innerHTML = '<div style="padding:20px; text-align:center; color:#666">Searching via Proxy...</div>';
        
        try {
            const url = `${API}/manga?title=${encodeURIComponent(q)}&limit=10&includes[]=cover_art&contentRating[]=safe&contentRating[]=suggestive&contentRating[]=erotica`;
            
            const data = await fetchSafe(url);
            view.innerHTML = '';

            if(!data.data || !data.data.length) {
                view.innerHTML = '<div style="padding:20px; text-align:center">No results found.</div>';
                return;
            }

            data.data.forEach(m => {
                const title = m.attributes.title.en || Object.values(m.attributes.title)[0];
                const coverRel = m.relationships.find(r => r.type === 'cover_art');
                const img = coverRel ? `${COVERS}/${m.id}/${coverRel.attributes.fileName}.256.jpg` : null;
                
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <img src="${img || 'https://via.placeholder.com/80x120'}" class="cover">
                    <div class="info">
                        <div class="title">${title}</div>
                        <div class="actions">
                            <button class="btn-act" style="background:var(--accent); color:white" 
                                onclick="add('${m.id}', '${escapeHtml(title)}', '${img}')">Track</button>
                        </div>
                    </div>
                `;
                view.appendChild(div);
            });
        } catch(e) { 
            console.error(e);
            view.innerHTML = `
                <div class="error-box">
                    <strong>Connection Failed</strong><br>
                    <small>${e.message}</small><br>
                    <small>If this persists, the proxy might be busy. Try again in a moment.</small>
                </div>
            `; 
        }
    }

    // --- Library Logic ---
    function add(id, title, img) {
        title = unescapeHtml(title);
        if(!library.find(x => x.id === id)) {
            library.push({ id, title, img, lastChap: '...', lastLang: '', lastCheck: 0 });
            save();
            alert('Added!');
            refreshItem(library[library.length-1]);
        }
    }

    function remove(id) {
        if(confirm('Stop tracking?')) {
            library = library.filter(x => x.id !== id);
            save();
            renderLib();
        }
    }

    // --- Auto-Update Logic ---
    async function refreshAll() {
        const btn = document.getElementById('refresh-btn');
        btn.textContent = 'Updating...';
        await Promise.all(library.map(refreshItem));
        save();
        renderLib();
        btn.textContent = 'Check Now';
    }

    async function refreshItem(item) {
        try {
            // Add a timestamp to prevent caching old data
            const cacheBuster = `&_=${Date.now()}`;
            const url = `${API}/chapter?manga=${item.id}&order[chapter]=desc&limit=1${cacheBuster}`;
            
            const data = await fetchSafe(url);

            if(data.data && data.data.length) {
                const chap = data.data[0].attributes;
                item.lastChap = chap.chapter;
                item.lastLang = chap.translatedLanguage ? chap.translatedLanguage.toUpperCase() : 'RAW';
                item.status = 'ok';
            } else {
                item.lastChap = '?';
                item.status = 'licensed';
            }
            item.lastCheck = Date.now();
        } catch(e) {
            console.error(e);
            item.status = 'error';
        }
    }

    // --- Rendering ---
    function renderLib() {
        const view = document.getElementById('lib-view');
        view.innerHTML = '';
        
        if(!library.length) {
            view.innerHTML = '<div style="text-align:center; padding:40px; color:#666">Library empty.</div>';
            return;
        }

        library.sort((a,b) => b.lastCheck - a.lastCheck);

        library.forEach(item => {
            const div = document.createElement('div');
            div.className = 'card';
            
            let badgeHtml = '';
            let actionHtml = '';

            if (item.status === 'licensed') {
                badgeHtml = `<div class="badge licensed">No Data (Licensed)</div>`;
                actionHtml = `
                    <button class="btn-act" onclick="googleSearch('${item.title}')">Google It âžœ</button>
                    <button class="btn-remove" onclick="remove('${item.id}')">Drop</button>
                `;
            } else if (item.status === 'error') {
                badgeHtml = `<div class="badge" style="background:#330000; color:#ff5252">Connection Error</div>`;
                actionHtml = `<button class="btn-remove" onclick="remove('${item.id}')">Drop</button>`;
            } else {
                badgeHtml = `
                    <div class="badge latest">
                        Ch. ${item.lastChap}
                        <span class="lang-tag">${item.lastLang}</span>
                    </div>
                `;
                actionHtml = `
                    <a href="https://mangadex.org/title/${item.id}" target="_blank" style="text-decoration:none">
                        <button class="btn-act">Read</button>
                    </a>
                    <button class="btn-remove" onclick="remove('${item.id}')">Drop</button>
                `;
            }

            const time = item.lastCheck ? 'Updated just now' : ''; 

            div.innerHTML = `
                <img src="${item.img || 'https://via.placeholder.com/80x120'}" class="cover">
                <div class="info">
                    <div>
                        <div class="title">${item.title}</div>
                        <div class="status-row">
                            ${badgeHtml}
                        </div>
                        <div class="meta">${time}</div>
                    </div>
                    <div class="actions">
                        ${actionHtml}
                    </div>
                </div>
            `;
            view.appendChild(div);
        });
    }

    function googleSearch(title) {
        window.open(`https://www.google.com/search?q=${encodeURIComponent(title + ' manga latest chapter')}`, '_blank');
    }

    // --- Utils ---
    function save() { localStorage.setItem('manga_auto_v1', JSON.stringify(library)); }
    function switchTab(t) {
        document.getElementById('lib-view').style.display = t === 'lib' ? 'flex' : 'none';
        document.getElementById('search-view').style.display = t === 'search' ? 'flex' : 'none';
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        document.querySelector(`.tab[onclick="switchTab('${t}')"]`).classList.add('active');
    }
    function escapeHtml(s) { return s.replace(/'/g, "&apos;").replace(/"/g, "&quot;"); }
    function unescapeHtml(s) { return s.replace(/&apos;/g, "'").replace(/&quot;/g, '"'); }

</script>

</body>
</html>
